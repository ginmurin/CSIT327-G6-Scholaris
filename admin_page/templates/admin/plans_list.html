{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Manage Study Plans</title>
  <link rel="stylesheet" href="{% static 'admin/css/home.css' %}">
  <style>
    .search-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    .search-input:focus {
      border-color: #7a57ff;
      box-shadow: 0 0 0 3px rgba(122, 87, 255, 0.1);
    }

    .filter-select {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: #fff;
      cursor: pointer;
      min-width: 150px;
    }

    .filter-select:focus {
      border-color: #7a57ff;
      box-shadow: 0 0 0 3px rgba(122, 87, 255, 0.1);
    }

    .plan-table {
      width: 100%;
    }

    .plan-table-header {
      background: #f7f6ff;
      font-weight: 900;
      color: #555;
      display: grid;
      grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 0.8fr;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px 10px 0 0;
      align-items: center;
    }

    .plan-table-row {
      display: grid;
      grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 0.8fr;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
      background: #fff;
    }

    .plan-table-row:hover {
      background: #fafbff;
    }

    .plan-title-cell {
      font-weight: 700;
      color: #1f1f1f;
      word-break: break-word;
    }

    .plan-user-cell {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .plan-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #6a7cff, #9b5cff);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 11px;
      font-weight: 900;
      flex-shrink: 0;
      overflow: hidden;
    }

    .plan-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .plan-user-name {
      font-weight: 600;
    }

    .plan-status {
      display: inline-block;
      font-size: 11px;
      font-weight: 900;
      padding: 5px 10px;
      border-radius: 6px;
      text-align: center;
      text-transform: uppercase;
    }

    .plan-status.active {
      background: #e9f7ee;
      color: #1f8a3b;
    }

    .plan-status.completed {
      background: #e3f2fd;
      color: #1565c0;
    }

    .plan-category {
      font-size: 12px;
      color: #666;
    }

    .plan-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .plan-action-btn {
      padding: 0 12px;
      height: 28px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 800;
      border: none;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: all 0.15s ease;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
      line-height: 1;
    }

    .plan-action-btn.view {
      background: #7a57ff;
      color: #fff;
    }

    .plan-action-btn.view:hover {
      background: #6a47dd;
    }

    .plan-action-btn.delete {
      background: #ff5d7b;
      color: #fff;
    }

    .plan-action-btn.delete:hover {
      background: #dd4d6b;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    @media (max-width: 900px) {
      .plan-table-header,
      .plan-table-row {
        grid-template-columns: 1.5fr 1.5fr 1fr;
      }
    }

    @media (max-width: 600px) {
      .search-filter {
        flex-direction: column;
      }

      .search-input,
      .filter-select {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div class="page-bg">
  <div class="container">

    <header class="top-card">
      <div class="top-left">
        <div class="profile-avatar header-avatar">
          {% if admin_user.profile_src %}
            <img src="{{ admin_user.profile_src }}" alt="{{ admin_user.name }}" class="avatar-img">
          {% elif admin_user.profile_picture %}
            <img src="{{ admin_user.profile_picture }}" alt="{{ admin_user.name }}" class="avatar-img">
          {% else %}
            <div class="avatar-placeholder">{{ admin_user.name|first|upper }}</div>
          {% endif %}
        </div>
        <div>
          <h1>Manage Study Plans</h1>
          <p>View all study plans in the system.</p>
        </div>
      </div>

      <div class="top-actions">
        <a href="{% url 'admin_page:home' %}" class="btn-light">Back to Admin</a>
      </div>
    </header>

    <section class="white-card">
      <div class="card-header">
        <h2>All Study Plans</h2>
      </div>

      <div class="search-filter">
        <form method="get" action="{% url 'admin_page:plans_list' %}" style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%; align-items: center;">
          <input 
            type="text" 
            name="q" 
            value="{{ q|default:'' }}" 
            placeholder="Search by title..."
            class="search-input"
            style="flex: 1; min-width: 200px;"
          />
          
          <select name="status" class="filter-select" style="min-width: 150px;">
            <option value="">All Status</option>
            <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
            <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
          </select>

          <select name="category" class="filter-select" style="min-width: 180px;">
            <option value="">All Categories</option>
            {% for value, label in topic_categories %}
              {% if value %}
                <option value="{{ value }}" {% if category == value %}selected{% endif %}>{{ label }}</option>
              {% endif %}
            {% endfor %}
          </select>

          <button class="btn-mini" type="submit">Search</button>
          {% if q or status or category %}
          <a href="{% url 'admin_page:plans_list' %}" class="btn-light" style="text-decoration: none;">Clear</a>
          {% endif %}
        </form>
      </div>

      {% if plans %}
      <div class="plan-table">
        <div class="plan-table-header">
          <div>Plan Title</div>
          <div>User</div>
          <div>Status</div>
          <div>Category</div>
          <div>Duration</div>
          <div>Action</div>
        </div>

        {% for plan in plans %}
        <div class="plan-table-row">
          <div class="plan-title-cell">{{ plan.title }}</div>

          <div class="plan-user-cell">
            <div class="plan-user-avatar">
              {% if plan.user.profile_src %}
                <img src="{{ plan.user.profile_src }}" alt="{{ plan.user.name }}">
              {% else %}
                {{ plan.user.name|first|upper }}
              {% endif %}
            </div>
            <span class="plan-user-name">{{ plan.user.name }}</span>
          </div>

          <div>
            <span class="plan-status {{ plan.status|lower }}">{{ plan.status|upper }}</span>
          </div>

          <div class="plan-category">
            {{ plan.get_topic_category_display }}
          </div>

          <div style="text-align: center; font-size: 12px;">
            {{ plan.start_date|date:"M d" }} - {{ plan.end_date|date:"M d, Y" }}
          </div>

          <div class="plan-actions">
            <a href="{% url 'admin_page:open_plan' plan.id %}" class="plan-action-btn view">View</a>
            <form method="post" action="{% url 'admin_page:delete_plan' plan.id %}" class="delete-form" style="display: inline;">
              {% csrf_token %}
              <button class="plan-action-btn delete" type="submit" data-plan-title="{{ plan.title }}">Delete</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ“š</div>
        <div style="font-size: 16px; margin-bottom: 8px;">No study plans found</div>
        <div style="font-size: 13px; color: #bbb;">Try adjusting your search or filters</div>
      </div>
      {% endif %}
    </section>

  </div>
</div>

<div id="deleteModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <h3 class="modal-title">Delete study plan?</h3>
    <p class="modal-text">
      Are you sure you want to delete <span id="deletePlanTitle">this study plan</span>?
      This action cannot be undone.
    </p>

    <div class="modal-actions">
      <button id="cancelDelete" class="btn-light" type="button">Cancel</button>
      <button id="confirmDelete" class="btn-mini danger" type="button">Yes, Delete</button>
    </div>
  </div>
</div>

<script>
  (function(){
    const modal = document.getElementById("deleteModal");
    const cancelBtn = document.getElementById("cancelDelete");
    const confirmBtn = document.getElementById("confirmDelete");
    const titleSpan = document.getElementById("deletePlanTitle");

    let pendingForm = null;

    document.querySelectorAll(".delete-form button[type='submit']").forEach(btn => {
      btn.addEventListener("click", function(e){
        e.preventDefault();
        pendingForm = this.closest("form");
        titleSpan.textContent = this.dataset.planTitle || "this study plan";
        modal.style.display = "flex";
      });
    });

    cancelBtn.addEventListener("click", () => {
      modal.style.display = "none";
      pendingForm = null;
    });

    modal.addEventListener("click", (e) => {
      if(e.target === modal){
        modal.style.display = "none";
        pendingForm = null;
      }
    });

    confirmBtn.addEventListener("click", () => {
      if(pendingForm) pendingForm.submit();
    });

    // Auto-submit filter when status or category changes
    const statusSelect = document.querySelector('select[name="status"]');
    const categorySelect = document.querySelector('select[name="category"]');
    
    if(statusSelect) {
      statusSelect.addEventListener('change', function() {
        this.closest('form').submit();
      });
    }
    
    if(categorySelect) {
      categorySelect.addEventListener('change', function() {
        this.closest('form').submit();
      });
    }
  })();
</script>

</body>
</html>
